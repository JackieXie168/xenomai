<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Xenomai API: include/nucleus/bheap.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.2 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<div class="nav">
<a class="el" href="dir_000000.html">include</a>&nbsp;/&nbsp;<a class="el" href="dir_000006.html">nucleus</a></div>
<h1>bheap.h</h1><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * Copyright (C) 2006 Gilles Chanteperdrix &lt;gilles.chanteperdrix@laposte.net&gt;</span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> * Xenomai is free software; you can redistribute it and/or modify</span>
00005 <span class="comment"> * it under the terms of the GNU General Public License as published</span>
00006 <span class="comment"> * by the Free Software Foundation; either version 2 of the License,</span>
00007 <span class="comment"> * or (at your option) any later version.</span>
00008 <span class="comment"> *</span>
00009 <span class="comment"> * Xenomai is distributed in the hope that it will be useful, but</span>
00010 <span class="comment"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
00012 <span class="comment"> * General Public License for more details.</span>
00013 <span class="comment"> *</span>
00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
00015 <span class="comment"> * along with Xenomai; if not, write to the Free Software</span>
00016 <span class="comment"> * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA</span>
00017 <span class="comment"> * 02111-1307, USA.</span>
00018 <span class="comment"> */</span>
00019 
00020 <span class="preprocessor">#ifndef _XENO_NUCLEUS_BHEAP_H</span>
00021 <span class="preprocessor"></span><span class="preprocessor">#define _XENO_NUCLEUS_BHEAP_H</span>
00022 <span class="preprocessor"></span>
00023 <span class="preprocessor">#include &lt;nucleus/compiler.h&gt;</span>
00024 
00025 <span class="comment">/* Priority queue implementation, using a binary heap. */</span>
00026 
00027 <span class="keyword">typedef</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> bheap_key_t;
00028 
00029 <span class="keyword">typedef</span> <span class="keyword">struct </span>bheaph {
00030     bheap_key_t key;
00031     <span class="keywordtype">unsigned</span> prio;
00032     <span class="keywordtype">unsigned</span> pos;
00033 } bheaph_t;
00034 
00035 <span class="preprocessor">#define bheaph_init(holder) do { } while (0)</span>
00036 <span class="preprocessor"></span><span class="preprocessor">#define bheaph_key(holder)  ((holder)-&gt;key)</span>
00037 <span class="preprocessor"></span><span class="preprocessor">#define bheaph_prio(holder) ((holder)-&gt;prio)</span>
00038 <span class="preprocessor"></span><span class="preprocessor">#define bheaph_pos(holder)  ((holder)-&gt;pos)</span>
00039 <span class="preprocessor"></span><span class="preprocessor">#define bheaph_lt(h1, h2)   ((h1)-&gt;key &lt; (h2)-&gt;key ||     \</span>
00040 <span class="preprocessor">                             ((h1)-&gt;key == (h2)-&gt;key &amp;&amp;   \</span>
00041 <span class="preprocessor">                              (h1)-&gt;prio &gt; (h2)-&gt;prio))</span>
00042 <span class="preprocessor"></span>
00043 <span class="keyword">typedef</span> <span class="keyword">struct </span>bheap {
00044     <span class="keywordtype">unsigned</span> sz;
00045     <span class="keywordtype">unsigned</span> last;
00046     bheaph_t **elems;
00047 } bheap_t;
00048 
00049 <span class="keyword">static</span> <span class="keyword">inline</span> bheaph_t *bheap_gethead(bheap_t *heap)
00050 {
00051     <span class="keywordflow">if</span> (heap-&gt;last == 1)
00052         <span class="keywordflow">return</span> NULL;
00053 
00054     <span class="keywordflow">return</span> heap-&gt;elems[1];
00055 }
00056 
00057 <span class="keyword">static</span> <span class="keyword">inline</span> bheaph_t *bheaph_parent(bheap_t *heap, bheaph_t *holder)
00058 {
00059     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> pos = holder-&gt;pos;
00060 
00061     <span class="keywordflow">return</span> likely(pos &gt; 1) ? heap-&gt;elems[pos / 2] : NULL;
00062 }
00063 
00064 <span class="keyword">static</span> <span class="keyword">inline</span> bheaph_t *bheaph_child(bheap_t *heap, bheaph_t *holder, <span class="keywordtype">int</span> side)
00065 {
00066     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> pos = 2 * holder-&gt;pos + side;
00067 
00068     <span class="keywordflow">return</span> likely(pos &lt; heap-&gt;last) ? heap-&gt;elems[pos] : NULL;
00069 }
00070 
00071 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> bheap_init(bheap_t *heap, <span class="keywordtype">unsigned</span> sz)
00072 {
00073     heap-&gt;sz = sz;
00074     heap-&gt;last = 1;
00075     heap-&gt;elems = (bheaph_t **) xnarch_sysalloc(sz * <span class="keyword">sizeof</span>(<span class="keywordtype">void</span> *));
00076 
00077     <span class="keywordflow">if</span> (!heap-&gt;elems)
00078         <span class="keywordflow">return</span> ENOMEM;
00079 
00080     <span class="comment">/* start indexing at 1. */</span>
00081     heap-&gt;elems -= 1;
00082 
00083     <span class="keywordflow">return</span> 0;
00084 }
00085 
00086 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> bheap_destroy(bheap_t *heap)
00087 {    
00088     xnarch_sysfree(heap-&gt;elems + 1, heap-&gt;sz * <span class="keyword">sizeof</span>(<span class="keywordtype">void</span> *));
00089     heap-&gt;last = 0;
00090     heap-&gt;sz = 0;
00091 }
00092 
00093 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> bheap_swap(bheap_t *heap, bheaph_t *h1, bheaph_t *h2)
00094 {
00095     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> pos2 = bheaph_pos(h2);
00096 
00097     heap-&gt;elems[bheaph_pos(h1)] = h2;
00098     bheaph_pos(h2) = bheaph_pos(h1);
00099     heap-&gt;elems[pos2] = h1;
00100     bheaph_pos(h1) = pos2;
00101 }
00102 
00103 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> bheap_up(bheap_t *heap, bheaph_t *holder)
00104 {
00105     bheaph_t *parent;
00106 
00107     <span class="keywordflow">while</span> ((parent = bheaph_parent(heap, holder)) &amp;&amp; bheaph_lt(holder, parent))
00108         bheap_swap(heap, holder, parent);
00109 }
00110 
00111 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> bheap_down(bheap_t *heap, bheaph_t *holder)
00112 {
00113     bheaph_t *left, *right, *minchild;
00114 
00115     <span class="keywordflow">for</span> (;;) {
00116         left = bheaph_child(heap, holder, 0);
00117         right = bheaph_child(heap, holder, 1);
00118         
00119         <span class="keywordflow">if</span> (left &amp;&amp; right)
00120             minchild = bheaph_lt(left, right) ? left : right;
00121         <span class="keywordflow">else</span>
00122             minchild = left ?: right;
00123 
00124         <span class="keywordflow">if</span> (!minchild || bheaph_lt(holder, minchild))
00125             <span class="keywordflow">break</span>;
00126 
00127         bheap_swap(heap, minchild, holder);
00128     }
00129 }
00130 
00131 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> bheap_insert(bheap_t *heap, bheaph_t *holder)
00132 {
00133     <span class="keywordflow">if</span> (heap-&gt;last == heap-&gt;sz + 1)
00134         <span class="keywordflow">return</span> EBUSY;
00135 
00136     heap-&gt;elems[heap-&gt;last] = holder;
00137     bheaph_pos(holder) = heap-&gt;last;
00138     ++heap-&gt;last;
00139     bheap_up(heap, holder);
00140     <span class="keywordflow">return</span> 0;
00141 }
00142 
00143 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> bheap_delete(bheap_t *heap, bheaph_t *holder)
00144 {
00145     bheaph_t *lasth;
00146     
00147     <span class="keywordflow">if</span> (heap-&gt;last == 1)
00148         <span class="keywordflow">return</span> EINVAL;
00149     
00150     --heap-&gt;last;
00151     <span class="keywordflow">if</span> (heap-&gt;last &gt; 1) {
00152         lasth = heap-&gt;elems[heap-&gt;last];
00153         heap-&gt;elems[bheaph_pos(holder)] = lasth;
00154         bheaph_pos(lasth) = bheaph_pos(holder);
00155         bheap_down(heap, lasth);
00156     }
00157    
00158     <span class="keywordflow">return</span> 0;
00159 }
00160 
00161 <span class="keyword">static</span> <span class="keyword">inline</span> bheaph_t *bheap_get(bheap_t *heap)
00162 {
00163     bheaph_t *holder = bheap_gethead(heap);
00164 
00165     <span class="keywordflow">if</span> (!holder)
00166         <span class="keywordflow">return</span> NULL;
00167 
00168     bheap_delete(heap, holder);
00169 
00170     <span class="keywordflow">return</span> holder;
00171 }
00172 
00173 <span class="preprocessor">#endif </span><span class="comment">/* _XENO_NUCLEUS_BHEAP_H */</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Apr 6 14:44:19 2006 for Xenomai API by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.2 </small></address>
</body>
</html>
